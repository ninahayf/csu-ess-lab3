---
title: "Lab 3: COVID-19"
subtitle: 'Ecosystem Science and Sustainability 330'
author: 
  - name: "ninahayf.github.io"
  - email: "ninahayf@colostate.edu"
format: html
---

```{r setup, include=FALSE}
library(tidyverse)
library(flextable)
library(zoo)
library(lubridate)
```

# Load Data
```{r}
data <- read_csv('https://raw.githubusercontent.com/nytimes/covid-19-data/master/us-counties.csv')
```

# Define Parameters 
```{r}
my.date <- as.Date("2022-02-01")
my.state <- "Colorado"
```

# Filter and Process Data 
```{r}
co_data <- data %>%
  filter(state == my.state) %>%
  group_by(county) %>%
  arrange(date) %>%
  mutate(new_cases = cases - lag(cases, default = 0), new_deaths = deaths - lag(deaths, default = 0)) %>%
  ungroup()
```

# Generate Summary Tables
```{r}
top_cumulative <- co_data %>%
  filter(date == my.date) %>%
  arrange(desc(cases)) %>%
  head(5)

flextable(top_cumulative) %>%
  set_caption("Top 5 Counties by Cumulative Cases")

top_new <- co_data %>%
  filter(date == my.date) %>%
  arrange(desc(new_cases)) %>%
  head(5)

flextable(top_new) %>%
  set_caption("Top 5 Counties by New Cases")
```

# Load Population Data 
```{r}
pop_url <- 'https://www2.census.gov/programs-surveys/popest/datasets/2020-2023/counties/totals/co-est2023-alldata.csv'
pop_data <- read_csv(pop_url, show_col_types = FALSE)

pop_data <- pop_data %>%
  rename_with(~ gsub(" ", "_", .x))

if("STATE" %in% colnames(pop_data) & "COUNTY" %in% colnames(pop_data)) {
  pop_data <- pop_data %>%
    mutate(STATE = str_pad(as.character(STATE), width = 2, side = "left", pad = "0"),
           COUNTY = str_pad(as.character(COUNTY), width = 3, side = "left", pad = "0"),
           FIPS = paste0(STATE, COUNTY)) %>%
    select(matches("NAME|2021"), FIPS)
} else {
  stop("Error: STATE or COUNTY column not found in population data.")
}

pop_data <- pop_data %>%
  mutate(FIPS = as.character(FIPS))
```

# Merge COVID and Population Data 
```{r}
co_data <- co_data %>%
  mutate(fips = as.character(fips))

pop_col <- names(pop_data)[grepl("2021", names(pop_data))][1]

merged_data <- co_data %>%
  left_join(pop_data, by = c("fips" = "FIPS")) %>%
  mutate(per_capita_cases = cases / get(pop_col), per_capita_new_cases = new_cases / get(pop_col))
```

# Rolling 14-day Analysis
```{r}
rolling_14 <- merged_data %>%
  filter(date >= my.date - 13 & date <= my.date) %>%
  group_by(county) %>%
  summarize(total_new_cases = sum(new_cases, na.rm = TRUE), per_100k = (total_new_cases / first(get(pop_col))) * 100000, .groups = "drop") %>%
  arrange(desc(per_100k))
```

# Visualization for Multi-State Analysis
```{r}
states <- c("New York", "Colorado", "Alabama", "Ohio")
state_data <- data %>%
  filter(state %in% states) %>%
  group_by(state, date) %>%
  summarize(new_cases = sum(cases - lag(cases, default = 0), na.rm = TRUE), .groups = "drop") %>%
  mutate(rolling_avg = rollmean(new_cases, 7, fill = NA))

ggplot(state_data, aes(x = date, y = rolling_avg, color = state)) +
  geom_line() +
  labs(title = "7-day Rolling Average of New Cases", y = "New Cases", x = "Date")
```

# Spatial Analysis (Weighted Mean Center)
```{r}

```








